<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Detection CSV Export Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .export-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .export-section h3 {
            margin-top: 0;
            color: #555;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .info {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöó Car Detection CSV Export Test</h1>
        
        <div class="info">
            <strong>üìã Instructions:</strong><br>
            1. First create some sample data using the "Create Sample Data" button<br>
            2. Then test the CSV export functionality with different time ranges<br>
            3. The CSV file will be downloaded directly to your browser's download folder
        </div>

        <div class="export-section">
            <h3>üìä Create Sample Data</h3>
            <button onclick="createSampleData()">Create Sample Data</button>
            <p><small>Creates 10 sample car detection records for testing</small></p>
        </div>

        <div class="export-section">
            <h3>üì• Export CSV Files (Direct Download)</h3>
            
            <h4>Predefined Time Ranges:</h4>
            <button onclick="exportCSV('1hour')">Export Last 1 Hour</button>
            <button onclick="exportCSV('24hours')">Export Last 24 Hours</button>
            <button onclick="exportCSV('7days')">Export Last 7 Days</button>
            <button onclick="exportCSV('30days')">Export Last 30 Days</button>
            
            <h4>Custom Date Range:</h4>
            <input type="date" id="startDate" value="">
            <input type="date" id="endDate" value="">
            <button onclick="exportCustomRange()">Export Custom Range</button>
        </div>

        <div class="export-section">
            <h3>üìà View Data (JSON)</h3>
            <button onclick="viewData('24hours')">View Last 24 Hours Data</button>
            <button onclick="viewData('7days')">View Last 7 Days Data</button>
            <button onclick="viewData('30days')">View Last 30 Days Data</button>
        </div>

        <div id="status" class="status"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api/car-detection';
        
        // Set default dates
        const today = new Date();
        const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        document.getElementById('endDate').value = today.toISOString().split('T')[0];
        document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];

        function showStatus(message, type = 'success') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function showLoading(button, text = 'Loading...') {
            const originalText = button.textContent;
            button.disabled = true;
            button.innerHTML = `<span class="loading"></span>${text}`;
            return () => {
                button.disabled = false;
                button.textContent = originalText;
            };
        }

        async function createSampleData() {
            const button = event.target;
            const hideLoading = showLoading(button, 'Creating...');
            
            try {
                const sampleData = [
                    { distance: 5.2 },   // Car detected
                    { distance: 12.8 },  // No car
                    { distance: 3.1 },   // Car detected
                    { distance: 8.5 },   // No car
                    { distance: 6.9 },   // Car detected
                    { distance: 15.2 },  // No car
                    { distance: 4.8 },   // Car detected
                    { distance: 9.1 },   // No car
                    { distance: 2.5 },   // Car detected
                    { distance: 11.7 }   // No car
                ];

                let created = 0;
                for (const data of sampleData) {
                    try {
                        await fetch(`${API_BASE}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(data)
                        });
                        created++;
                    } catch (error) {
                        console.error('Error creating record:', error);
                    }
                }
                
                showStatus(`‚úÖ Successfully created ${created} sample records!`);
            } catch (error) {
                showStatus(`‚ùå Error creating sample data: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function exportCSV(timeRange) {
            const button = event.target;
            const hideLoading = showLoading(button, 'Exporting...');
            
            try {
                const response = await fetch(`${API_BASE}/export?timeRange=${timeRange}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Export failed');
                }

                // Get filename from Content-Disposition header
                const contentDisposition = response.headers.get('Content-Disposition');
                const filename = contentDisposition 
                    ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                    : `car-detection-${timeRange}.csv`;

                // Create blob and download
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showStatus(`‚úÖ CSV file "${filename}" downloaded successfully!`);
            } catch (error) {
                showStatus(`‚ùå Export failed: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function exportCustomRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) {
                showStatus('‚ùå Please select both start and end dates', 'error');
                return;
            }

            const button = event.target;
            const hideLoading = showLoading(button, 'Exporting...');
            
            try {
                const startISO = new Date(startDate + 'T00:00:00.000Z').toISOString();
                const endISO = new Date(endDate + 'T23:59:59.999Z').toISOString();
                
                const response = await fetch(`${API_BASE}/export?startDate=${startISO}&endDate=${endISO}`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Export failed');
                }

                // Get filename and download
                const contentDisposition = response.headers.get('Content-Disposition');
                const filename = contentDisposition 
                    ? contentDisposition.split('filename=')[1].replace(/"/g, '')
                    : `car-detection-custom.csv`;

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showStatus(`‚úÖ CSV file "${filename}" downloaded successfully!`);
            } catch (error) {
                showStatus(`‚ùå Export failed: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        async function viewData(timeRange) {
            const button = event.target;
            const hideLoading = showLoading(button, 'Loading...');
            
            try {
                const response = await fetch(`${API_BASE}/data?timeRange=${timeRange}&limit=10`);
                const data = await response.json();
                
                if (data.success) {
                    console.log(`${timeRange} Data:`, data);
                    showStatus(`‚úÖ Loaded ${data.data.length} records. Check console for details.`);
                } else {
                    throw new Error(data.message || 'Failed to load data');
                }
            } catch (error) {
                showStatus(`‚ùå Error loading data: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>
